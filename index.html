<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Модульная игра в слова</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- Главная панель управления -->
        <div id="mainControls" class="main-controls">
            <!-- Селекторы -->
            <div class="selectors-group">
                <div class="selector-item">
                    <label for="languageSelect" data-i18n="selectLanguage">Язык:</label>
                    <div id="languageContainer"></div>
                </div>
                <div class="selector-item">
                    <label for="categorySelect" data-i18n="selectCategory">Категория:</label>
                    <div id="categoryContainer"></div>
                </div>
                <div class="selector-item">
                    <label for="keyboardLayoutSelect" data-i18n="selectKeyboardLayout">Раскладка:</label>
                    <div id="keyboardLayoutContainer"></div>
                </div>
            </div>
            
            <!-- Кнопки управления игрой -->
            <div class="game-controls">
                <button id="startButton" data-i18n="start">Старт</button>
                <button id="pauseButton" data-i18n="pause">Пауза</button>
                <button id="stopButton" data-i18n="stop">Стоп</button>
                <button id="adminButton" data-i18n="admin">Админ</button>
            </div>
        </div>

        <!-- Игровая область -->
        <div id="gameContainer">
            <div id="score" data-i18n="score">Очки: 0 (Уровень 1)</div>
            <canvas id="gameCanvas"></canvas>
        </div>

        <!-- Мобильная клавиатура -->
        <div id="keyboard"></div>

        <!-- Панель администратора (скрыта по умолчанию) -->
        <div id="adminPanel" class="admin-panel" style="display: none;">
            <div class="admin-header">
                <h2 data-i18n="admin">Администрирование</h2>
                <button id="backToGameButton" data-i18n="backToGame">Вернуться к игре</button>
            </div>
            
            <div class="admin-form">
                <div class="form-group">
                    <label for="newCategoryName" data-i18n="categoryName">Название категории:</label>
                    <input type="text" id="newCategoryName" placeholder="Введите название категории">
                </div>

                <div class="form-group">
                    <label for="categoryLanguage" data-i18n="selectLanguage">Выберите язык:</label>
                    <select id="categoryLanguage"></select>
                </div>

                <div class="form-group">
                    <label for="wordsFile" data-i18n="uploadWords">Загрузить файл со словами:</label>
                    <input type="file" id="wordsFile" accept=".txt">
                    <small>Формат: 1 - Слово</small>
                </div>

                <div class="form-group">
                    <label for="imagesFiles" data-i18n="uploadImages">Загрузить изображения:</label>
                    <input type="file" id="imagesFiles" accept=".png,.jpg,.jpeg" multiple>
                    <small>Названия файлов должны соответствовать номерам в файле слов</small>
                </div>

                <div class="form-actions">
                    <button id="validateButton" data-i18n="validate">Проверить</button>
                    <button id="saveButton" data-i18n="save" disabled>Сохранить</button>
                </div>

                <div id="validationResult" class="validation-result" style="display: none;">
                    <h3 data-i18n="validationResult">Результат проверки:</h3>
                    <div id="validationDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Подключение модулей -->
    <script src="modules/LanguageManager.js"></script>
    <script src="modules/DataManager.js"></script>
    <script src="modules/CategoryManager.js"></script>
    <script src="modules/GameEngine.js"></script>
    <script src="modules/AdminPanel.js"></script>
    
    <!-- Основной скрипт приложения -->
    <script>
        class App {
            constructor() {
                this.languageManager = null;
                this.dataManager = null;
                this.categoryManager = null;
                this.gameEngine = null;
                this.adminPanel = null;
                this.isInitialized = false;
            }

            async initialize() {
                try {
                    console.log('Инициализация приложения...');
                    
                    // Создание экземпляров менеджеров
                    this.languageManager = new LanguageManager();
                    this.dataManager = new DataManager();
                    this.categoryManager = new CategoryManager(this.dataManager, this.languageManager);
                    this.gameEngine = new GameEngine(this.dataManager, this.languageManager, this.categoryManager);
                    this.adminPanel = new AdminPanel(this.dataManager, this.languageManager, this.categoryManager);

                    // Инициализация модулей
                    await this.languageManager.initialize();
                    await this.dataManager.loadConfig();
                    await this.categoryManager.initialize();
                    await this.gameEngine.initialize();
                    await this.adminPanel.initialize();

                    // Создание UI элементов
                    this.setupUI();
                    
                    // Локализация интерфейса
                    this.languageManager.localizeDOM();
                    
                    this.isInitialized = true;
                    console.log('Приложение успешно инициализировано');
                    
                } catch (error) {
                    console.error('Ошибка инициализации приложения:', error);
                    this.showError('Ошибка загрузки приложения. Проверьте консоль для деталей.');
                }
            }

            setupUI() {
                // Создание селектора языков
                this.languageManager.createLanguageSelector('languageContainer', (newLanguage) => {
                    console.log(`Язык изменен на: ${newLanguage}`);
                    this.updateCategorySelector();
                    this.updateKeyboardLayoutSelector();
                    // Пересоздаем виртуальную клавиатуру с новой раскладкой
                    this.languageManager.createMobileKeyboard('keyboard', (key) => {
                        if (this.gameEngine.isGameActive()) {
                            this.gameEngine.handleKeyPress(key);
                        }
                    });
                });

                // Создание селектора категорий
                this.updateCategorySelector();

                // Создание селектора раскладки клавиатуры
                this.updateKeyboardLayoutSelector();

                // Создание мобильной клавиатуры
                this.languageManager.createMobileKeyboard('keyboard', (key) => {
                    if (this.gameEngine.isGameActive()) {
                        this.gameEngine.handleKeyPress(key);
                    }
                });

                // Обработчики кнопок администратора
                document.getElementById('adminButton').addEventListener('click', () => {
                    this.showAdminPanel();
                });

                document.getElementById('backToGameButton').addEventListener('click', () => {
                    this.hideAdminPanel();
                });

                // Адаптивное изменение размера канваса
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
            }

            updateCategorySelector() {
                const container = document.getElementById('categoryContainer');
                if (!container) return;

                // Очищаем контейнер
                container.innerHTML = '';

                // Создаем селектор
                const select = document.createElement('select');
                select.id = 'categorySelect';
                select.className = 'category-select';

                // Пустая опция
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'Выберите категорию';
                select.appendChild(emptyOption);

                // Добавляем категории
                const categories = this.dataManager.getCategories();
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    const currentLang = this.languageManager.getCurrentLanguage();
                    option.textContent = category.names[currentLang] || category.names.ru || category.id;
                    select.appendChild(option);
                });

                // Обработчик изменения
                select.addEventListener('change', async (e) => {
                    const categoryId = e.target.value;
                    if (categoryId) {
                        const currentLang = this.languageManager.getCurrentLanguage();
                        const success = await this.categoryManager.setCategory(categoryId, currentLang);
                        console.log(`Категория изменена на: ${categoryId}, успех: ${success}`);
                    } else {
                        this.categoryManager.reset();
                    }
                });

                container.appendChild(select);
            }

            updateKeyboardLayoutSelector() {
                const container = document.getElementById('keyboardLayoutContainer');
                if (!container) return;

                // Создаем селектор раскладки клавиатуры
                const selector = this.languageManager.createKeyboardLayoutSelector('keyboardLayoutContainer', (newLayout) => {
                    console.log(`Раскладка клавиатуры изменена на: ${newLayout}`);
                    // Пересоздаем мобильную клавиатуру с новой раскладкой
                    this.languageManager.createMobileKeyboard('keyboard', (key) => {
                        if (this.gameEngine.isGameActive()) {
                            this.gameEngine.handleKeyPress(key);
                        }
                    });
                });

                // Если селектор не был создан (только одна раскладка), 
                // убеждаемся что клавиатура все равно обновлена
                if (!selector) {
                    this.languageManager.createMobileKeyboard('keyboard', (key) => {
                        if (this.gameEngine.isGameActive()) {
                            this.gameEngine.handleKeyPress(key);
                        }
                    });
                }
            }

            showAdminPanel() {
                document.getElementById('adminPanel').style.display = 'block';
                document.body.style.overflow = 'hidden'; // Предотвращаем скролл фона
            }

            hideAdminPanel() {
                document.getElementById('adminPanel').style.display = 'none';
                document.body.style.overflow = 'auto'; // Восстанавливаем скролл
            }

            resizeCanvas() {
                const canvas = document.getElementById('gameCanvas');
                if (!canvas) return;

                // Более точное вычисление доступного пространства
                const mainControls = document.getElementById('mainControls');
                const keyboard = document.getElementById('keyboard');
                const score = document.getElementById('score');
                
                // Получаем фактические размеры элементов
                const mainControlsHeight = mainControls ? mainControls.offsetHeight : (isMobile ? 28 : 50);
                const scoreHeight = score ? score.offsetHeight : (isMobile ? 12 : 30);
                
                // Минимальные отступы
                const isMobile = window.innerWidth <= 480;
                const isDesktop = window.innerWidth >= 1200;
                const padding = isMobile ? 2 : 40; // Минимальные отступы на мобильных
                
                // На десктопе клавиатура скрыта, поэтому не учитываем ее высоту
                const keyboardHeight = isDesktop ? 0 : (keyboard ? keyboard.offsetHeight : (isMobile ? 90 : 80)); // Большие кнопки клавиатуры
                
                const availableHeight = window.innerHeight - mainControlsHeight - keyboardHeight - scoreHeight - padding;
                const availableWidth = window.innerWidth - (isMobile ? 10 : 40);
                
                let canvasWidth, canvasHeight;
                
                if (isMobile) {
                    // Мобильные устройства - максимальное использование доступного места
                    canvasWidth = Math.min(availableWidth * 0.99, 600);
                    canvasHeight = Math.min(availableHeight * 0.96, 500); // Больше высоты для мобильных
                    
                    // Более свободное соотношение сторон для мобильных
                    const minAspectRatio = 0.8; // минимум 4:5
                    const maxAspectRatio = 1.5; // максимум 3:2
                    
                    let currentRatio = canvasWidth / canvasHeight;
                    if (currentRatio < minAspectRatio) {
                        canvasWidth = canvasHeight * minAspectRatio;
                    } else if (currentRatio > maxAspectRatio) {
                        canvasHeight = canvasWidth / maxAspectRatio;
                    }
                }
                // Планшеты
                else if (window.innerWidth <= 1024) {
                    canvasWidth = Math.min(availableWidth * 0.95, 800);
                    canvasHeight = Math.min(availableHeight * 0.9, 600);
                    
                    // Соотношение сторон 4:3 для планшетов
                    const aspectRatio = 4 / 3;
                    if (canvasWidth / canvasHeight > aspectRatio) {
                        canvasWidth = canvasHeight * aspectRatio;
                    } else {
                        canvasHeight = canvasWidth / aspectRatio;
                    }
                }
                // Десктопы
                else {
                    canvasWidth = Math.min(availableWidth * 0.9, 1200);
                    canvasHeight = Math.min(availableHeight * 0.9, 900);
                    
                    // Соотношение сторон 4:3 для десктопа
                    const aspectRatio = 4 / 3;
                    if (canvasWidth / canvasHeight > aspectRatio) {
                        canvasWidth = canvasHeight * aspectRatio;
                    } else {
                        canvasHeight = canvasWidth / aspectRatio;
                    }
                }
                
                // Более разумные минимальные размеры
                canvasWidth = Math.max(isMobile ? 280 : 400, canvasWidth);
                canvasHeight = Math.max(isMobile ? 200 : 300, canvasHeight);
                
                // Увеличиваем максимальные размеры
                canvasWidth = Math.min(1600, canvasWidth);
                canvasHeight = Math.min(1200, canvasHeight);
                
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                canvas.style.width = canvasWidth + 'px';
                canvas.style.height = canvasHeight + 'px';
                
                console.log(`Canvas resized to ${canvasWidth}x${canvasHeight} for screen ${window.innerWidth}x${window.innerHeight}, available: ${availableWidth}x${availableHeight}`);
                
                // Уведомляем игровой движок об изменении размера
                if (this.gameEngine && this.gameEngine.handleResize) {
                    this.gameEngine.handleResize(canvasWidth, canvasHeight);
                }
            }

            showError(message) {
                alert(message); // Простое уведомление об ошибке
            }
        }

        // Создание и инициализация приложения
        const app = new App();
        
        // Инициализация после загрузки DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.initialize());
        } else {
            app.initialize();
        }
    </script>
</body>
</html> 